name: Sync upstream into customized fork

on:
  schedule:
    - cron: "17 3 * * 1,4"   # Mon & Thu at 03:17 UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      UPSTREAM: ExLibrisGroup/customModule
      DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}

    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ env.DEFAULT_BRANCH }}

      - name: Configure git identity
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Add upstream + fetch
        run: |
          git remote add upstream "https://github.com/${UPSTREAM}.git" || true
          git fetch --prune origin
          git fetch --prune upstream

      - name: Make local branch exactly match fork branch (no ff-only pulls)
        run: |
          git checkout "$DEFAULT_BRANCH"
          git reset --hard "origin/$DEFAULT_BRANCH"

      - name: Merge upstream into fork (README handled by .gitattributes)
        id: merge
        run: |
          set -e

          # Needed so merge=ours in .gitattributes works on the runner
          git config merge.ours.driver true

          echo "Merging upstream/$DEFAULT_BRANCH into $DEFAULT_BRANCH..."
          set +e
          git merge --no-edit "upstream/$DEFAULT_BRANCH"
          MERGE_EXIT=$?
          set -e

          # If merge failed, there are conflicts.
          if [ $MERGE_EXIT -ne 0 ]; then
            echo "mode=conflict" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # If merge succeeded, check if anything actually changed
          if git diff --quiet "origin/$DEFAULT_BRANCH..HEAD"; then
            echo "mode=noop" >> "$GITHUB_OUTPUT"
          else
            echo "mode=merged" >> "$GITHUB_OUTPUT"
          fi

      - name: Push merged changes to fork
        if: steps.merge.outputs.mode == 'merged'
        run: |
          echo "✅ Merge successful — pushing to origin/$DEFAULT_BRANCH"
          git push origin "$DEFAULT_BRANCH" --follow-tags

      - name: Stop if nothing to do
        if: steps.merge.outputs.mode == 'noop'
        run: echo "ℹ️ Up to date — nothing to push."

      - name: Create/update a single conflict branch
        if: steps.merge.outputs.mode == 'conflict'
        run: |
          echo "⚠️ Conflicts detected — creating/updating sync/conflicts"
          BR="sync/conflicts"
      
          # Stage files (this records the conflict-marked files so a PR can show them)
          git add -A || true
          git commit -m "Merge upstream/$DEFAULT_BRANCH into fork (conflicts)" || true
      
          # Push the current HEAD to the conflict branch WITHOUT checking it out
          git push -f origin HEAD:"$BR"
          # Clean up merge state
          git merge --abort || true


      - name: Create or update PR for conflicts
        if: steps.merge.outputs.mode == 'conflict'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: sync/conflicts
          title: "Sync conflicts with upstream"
          body: |
            This PR contains an attempted merge from upstream ${UPSTREAM} into ${DEFAULT_BRANCH}.
            Resolve conflicts and merge.
          base: ${{ env.DEFAULT_BRANCH }}
