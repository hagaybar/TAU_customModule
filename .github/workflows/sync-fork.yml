name: Sync upstream into customized fork

on:
  schedule:
    - cron: "17 3 * * 1,4"   # Runs Mon & Thu at 03:17 UTC
  workflow_dispatch:          # Allow manual trigger from the Actions tab

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      UPSTREAM: ExLibrisGroup/customModule         # Original repo slug
      DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}

    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ env.DEFAULT_BRANCH }}

      - name: Configure git
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Add and fetch upstream
        run: |
          git remote add upstream "https://github.com/${UPSTREAM}.git" || true
          git fetch --prune upstream

      - name: Merge upstream into local branch
        id: merge
        run: |
          set -e
          git checkout "$DEFAULT_BRANCH"
          echo "üîÑ Merging upstream/${DEFAULT_BRANCH} into local branch..."
          git merge --no-edit "upstream/$DEFAULT_BRANCH" || echo "conflict" > conflict.txt

          # üß† Auto-resolve README.md conflicts (keep local version)
          if git ls-files -u | grep -q "README.md"; then
            echo "Auto-resolving README.md conflicts (keep local version)..."
            git checkout --ours README.md
            git add README.md
          fi

          # Detect if conflicts remain
          if [ -f conflict.txt ]; then
            if git ls-files -u | grep -q .; then
              echo "mode=conflict" >> $GITHUB_OUTPUT
            else
              echo "mode=merged" >> $GITHUB_OUTPUT
            fi
          else
            echo "mode=merged" >> $GITHUB_OUTPUT
          fi

      - name: Push merged changes to fork
        if: steps.merge.outputs.mode == 'merged'
        run: |
          echo "‚úÖ Merge successful ‚Äî pushing changes to fork..."
          git push origin "$DEFAULT_BRANCH" --follow-tags

      - name: Prepare conflict branch for PR
        if: steps.merge.outputs.mode == 'conflict'
        run: |
          echo "‚ö†Ô∏è Conflicts detected ‚Äî preparing conflict branch for PR..."
          BR="sync/conflict-${{ github.run_id }}"
          git checkout -b "$BR"
          # Commit conflict markers so they appear in the PR diff
          git add -A || true
          git commit -m "Merge upstream with conflicts (auto-generated)" || true
          git push origin "$BR" || true

      - name: Create PR for conflicts
        if: steps.merge.outputs.mode == 'conflict'
        uses: peter-evans/create-pull-request@v6
        with:
          title: "‚ö†Ô∏è Merge conflicts when syncing with upstream"
          body: |
            This PR merges updates from upstream `${{ env.UPSTREAM }}` into your customized branch `${{ env.DEFAULT_BRANCH }}`.
            Conflicts were detected and committed so they can be resolved here.
          base: ${{ env.DEFAULT_BRANCH }}
          head: "sync/conflict-${{ github.run_id }}"
          commit-message: "Merge upstream/${{ env.DEFAULT_BRANCH }} into customized branch"
