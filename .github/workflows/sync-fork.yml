name: Sync fork from upstream

on:
  schedule:
    - cron: "7 3 * * 1,4"   # Runs Mon & Thu at 03:07 UTC
  workflow_dispatch:          # Allows manual trigger from Actions tab

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      UPSTREAM: ${{ vars.UPSTREAM }}
      DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}

    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ env.DEFAULT_BRANCH }}

      - name: Configure git
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream "https://github.com/${UPSTREAM}.git" || true
          git fetch --prune upstream

      - name: Fast-forward main branch
        run: |
          git checkout "$DEFAULT_BRANCH"
          git merge --ff-only "upstream/$DEFAULT_BRANCH" || {
            echo "Fast-forward failed (diverged). Please resolve manually."; exit 2;
          }

      - name: Push changes to fork
        run: git push origin "$DEFAULT_BRANCH" --follow-tags
