"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.runParallelAll = runParallelAll;
exports.runParallelMap = runParallelMap;
exports.dedupeEffectActions = dedupeEffectActions;
const exceptions_1 = require("../exceptions");
const batching_1 = require("../../tasks/batching");
async function runParallelAll(thunks) {
    const results = [];
    const pending = [];
    for (const thunk of thunks) {
        try {
            const value = await thunk();
            results.push(value);
        }
        catch (error) {
            const actions = collectPendingActions(error);
            if (actions.length) {
                pending.push(...actions);
                continue;
            }
            throw error;
        }
    }
    if (pending.length) {
        throw new exceptions_1.ParallelPendingError((0, batching_1.buildParallelBatch)(pending));
    }
    return results;
}
async function runParallelMap(items, fn) {
    const thunks = items.map((item) => () => fn(item));
    return runParallelAll(thunks);
}
function dedupeEffectActions(actions) {
    return (0, batching_1.buildParallelBatch)(actions).actions;
}
function collectPendingActions(error) {
    if (error instanceof exceptions_1.ParallelPendingError) {
        return error.batch.actions;
    }
    if (error instanceof exceptions_1.EffectPendingError || error instanceof exceptions_1.EffectRequestedError) {
        return [error.action];
    }
    return [];
}
