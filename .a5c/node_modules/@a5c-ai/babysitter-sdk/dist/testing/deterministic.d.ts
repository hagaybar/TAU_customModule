import type { JsonRecord } from "../storage/types";
import { type StateCacheSnapshot } from "../runtime/replay/stateCache";
type MaybePromise<T> = T | Promise<T>;
type ClockValue = string | number | Date;
export type ClockSequenceInput = ClockValue | readonly ClockValue[];
export interface SnapshotJournalEntry {
    seq: number;
    ulid: string;
    recordedAt: string;
    type: string;
    data: JsonRecord;
}
export interface SnapshotStateSummary {
    savedAt: string;
    stateVersion: number;
    journalHead: StateCacheSnapshot["journalHead"];
    pendingEffectsByKind: StateCacheSnapshot["pendingEffectsByKind"];
    effectsByInvocation: StateCacheSnapshot["effectsByInvocation"];
    rebuildReason: StateCacheSnapshot["rebuildReason"];
}
export interface DeterministicRunSnapshot {
    journal: SnapshotJournalEntry[];
    state: SnapshotStateSummary | null;
}
export interface TempDeterministicRun {
    runDir: string;
    cleanup(): Promise<void>;
    restore(): void;
}
export interface TempDeterministicRunOptions {
    processSource: string;
    inputs?: unknown;
    runId?: string;
    request?: string;
    clock?: ClockSequenceInput;
    ulids?: readonly string[];
}
export interface FixedClockOptions {
    start?: ClockValue;
    stepMs?: number;
    sequence?: ClockSequenceInput;
}
export interface FixedClockHandle {
    now(): Date;
    advance(ms?: number): Date;
    reset(): void;
    timestamp(): number;
    apply(): () => void;
    restore(): void;
}
export interface DeterministicUlidOptions {
    preset?: readonly string[];
    epochMs?: number;
    incrementMs?: number;
    randomnessSeed?: number;
}
export interface DeterministicUlidHandle {
    issued: readonly string[];
    next(): string;
    reset(): void;
    apply(): () => void;
    restore(): void;
}
export interface DeterministicRunHarnessOptions {
    processPath?: string;
    processSource?: string;
    inputs?: unknown;
    runId?: string;
    request?: string;
    exportName?: string;
    clock?: FixedClockOptions;
    ulids?: DeterministicUlidOptions;
}
export interface DeterministicRunHarness {
    runId: string;
    runDir: string;
    runsRoot: string;
    clock: FixedClockHandle;
    ulids: DeterministicUlidHandle;
    cleanup(): Promise<void>;
}
export declare function withDeterministicIds<T>(sequence: readonly string[], fn: () => MaybePromise<T>): Promise<T>;
export declare function withFixedClock<T>(sequenceOrValue: ClockSequenceInput, fn: () => MaybePromise<T>): Promise<T>;
export declare function createTempDeterministicRun(options: TempDeterministicRunOptions): Promise<TempDeterministicRun>;
export declare function snapshotRunState(runDir: string): Promise<DeterministicRunSnapshot>;
export declare function installFixedClock(options?: FixedClockOptions): FixedClockHandle;
export declare function installDeterministicUlids(options?: DeterministicUlidOptions): DeterministicUlidHandle;
export declare function createDeterministicRunHarness(options: DeterministicRunHarnessOptions): Promise<DeterministicRunHarness>;
export {};
//# sourceMappingURL=deterministic.d.ts.map